<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Data Collection with Pricing</title>
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <div class="form-card">
        <h2>Enter Your Details</h2>
        <h3 id="finalPrice" style="text-align:center; margin-top:20px;"></h3>
        <form id="userForm">
            <label for="age">Age (18-64)</label>
            <input class="agediv" type="number" id="age" name="age" min="18" max="64" required>

            <label for="gender">Gender</label>
            <select id="gender" name="gender" required>
                <option value="">Select Gender</option>
                <option value="M">Male</option>
                <option value="F">Female</option>
                <option value="O">Other</option>
            </select>

            <label for="state">State</label>
            <select id="state" name="state" required>
                <option value="">Select State</option>
                <option value="AL" data-name="Alabama">Alabama</option>
                <option value="AR" data-name="Arkansas">Arkansas</option>
                <option value="CO" data-name="Colorado">Colorado</option>
                <option value="DE" data-name="Delaware">Delaware</option>
                <option value="FL" data-name="Florida">Florida</option>
                <option value="GA" data-name="Georgia">Georgia</option>
                <option value="IA" data-name="Iowa">Iowa</option>
                <option value="IL" data-name="Illinois">Illinois</option>
                <option value="IN" data-name="Indiana">Indiana</option>
                <option value="KS" data-name="Kansas">Kansas</option>
                <option value="KY" data-name="Kentucky">Kentucky</option>
                <option value="LA" data-name="Louisiana">Louisiana</option>
                <option value="MD" data-name="Maryland">Maryland</option>
                <option value="MI" data-name="Michigan">Michigan</option>
                <option value="MO" data-name="Missouri">Missouri</option>
                <option value="MS" data-name="Mississippi">Mississippi</option>
                <option value="MT" data-name="Montana">Montana</option>
                <option value="NC" data-name="North Carolina">North Carolina</option>
                <option value="NE" data-name="Nebraska">Nebraska</option>
                <option value="NV" data-name="Nevada">Nevada</option>
                <option value="OH" data-name="Ohio">Ohio</option>
                <option value="OK" data-name="Oklahoma">Oklahoma</option>
                <option value="SC" data-name="South Carolina">South Carolina</option>
                <option value="SD" data-name="South Dakota">South Dakota</option>
                <option value="TN" data-name="Tennessee">Tennessee</option>
                <option value="TX" data-name="Texas">Texas</option>
                <option value="UT" data-name="Utah">Utah</option>
                <option value="VA" data-name="Virginia">Virginia</option>
                <option value="WI" data-name="Wisconsin">Wisconsin</option>
                <option value="WV" data-name="West Virginia">West Virginia</option>
                <option value="WY" data-name="Wyoming">Wyoming</option>
            </select>

            <label for="zip">Zip Code (optional)</label>
            <input type="text" class="agediv" id="zip" name="zip">

            <label style="margin-top: 20px;">
                Include Family
                <input type="checkbox" id="isFamily" />
            </label>

            <div id="familyFields" style="display: none;">
                <label for="spouseAge">Spouse Age (auto gendered)</label>
                <input class="agediv" type="number" id="spouseAge" min="18" max="64" />

                <label for="children">Number of Children</label>
                <input class="agediv" type="number" id="children" min="0" value="0" />
            </div>

            <button type="submit">Submit</button>
        </form>

        <div id="additionalLinks" class="additionalLinks">
            <a id="googleSearchLink" class="action-button" href="#" target="_blank">Search for places in this
                state</a><br>
            <a id="zillowLink" class="action-button" href="#" target="_blank">Check property values on Zillow</a>
        </div>
    </div>

    <script>
        document.getElementById('isFamily').addEventListener('change', function () {
            document.getElementById('familyFields').style.display = this.checked ? 'block' : 'none';
        });

        async function fetchSheetData() {
            try {
                const res = await fetch("http://localhost:3000/sheet-data");
                const json = await res.json();
                return json.data;
            } catch (err) {
                console.error("Error fetching sheet data:", err);
                return [];
            }
        }

        function getPrice(sheetData, age, gender, stateAbbr, association) {
            const match = sheetData.find(row =>
                row.State?.toUpperCase() === stateAbbr.toUpperCase() &&
                row.Gender?.toUpperCase() === gender.toUpperCase() &&
                parseInt(row.Age) === parseInt(age)
            );
            if (!match) return null;
            const assocKey = association.charAt(0).toUpperCase() + association.slice(1).toLowerCase();
            return parseFloat(match[assocKey]) || null;
        }

        document.getElementById('userForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const age = parseInt(document.getElementById('age').value);
            const gender = document.getElementById('gender').value;
            const stateAbbr = document.getElementById('state').value;
            const stateFullName = document.getElementById('state').selectedOptions[0].dataset.name;
            const zip = document.getElementById('zip').value.trim();
            const isFamily = document.getElementById('isFamily').checked;

            const sheetData = await fetchSheetData();

            // âœ… Use Plan labels instead of Bronze/Silver/Gold
            const associations = [
                { key: "Bronze", label: "Plan 1" },
                { key: "Silver", label: "Plan 2" },
                { key: "Gold", label: "Plan 3" }
            ];

            let results = [];

            associations.forEach(assoc => {
                let total = 0;
                const userPrice = getPrice(sheetData, age, gender, stateAbbr, assoc.key);
                if (userPrice !== null) total += userPrice;

                if (isFamily) {
                    const spouseAge = parseInt(document.getElementById('spouseAge').value);
                    const spouseGender = gender === 'M' ? 'F' : gender === 'F' ? 'M' : 'O';
                    const spousePrice = getPrice(sheetData, spouseAge, spouseGender, stateAbbr, assoc.key);
                    if (spousePrice !== null) total += spousePrice;

                    const numChildren = parseInt(document.getElementById('children').value) || 0;
                    total += numChildren * 100;
                }

                if (total > 0) {
                    const minPrice = total.toFixed(2);
                    const maxPrice = (total + 75).toFixed(2);
                    results.push(`${assoc.label}: $${minPrice} - $${maxPrice}`);
                } else {
                    results.push(`${assoc.label}: Price not found`);
                }

            });

            document.getElementById('finalPrice').innerHTML = results.join('<br>');


            document.getElementById('finalPrice').innerHTML = results.join('<br>');

            const googleSearchURL = `https://www.google.com/search?q=what+to+do+in+${stateFullName}${zip ? "+" + zip : ""}`;
            const zillowURL = `https://www.zillow.com/homes/${stateFullName}_rb/`;

            document.getElementById('googleSearchLink').href = googleSearchURL;
            document.getElementById('zillowLink').href = zillowURL;
            document.getElementById('additionalLinks').style.display = 'flex';
        });
    </script>
</body>

</html>